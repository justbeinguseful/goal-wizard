<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goal Wizard + Stripe & Airtable</title>
  <!-- Add Google Fonts for a more professional look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; 
      padding: 0;
      height: 100%; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: transparent; 
      color: #2D3748;
      line-height: 1.5;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
    }
    #wizard { 
      width: 100%;
      max-width: 400px; 
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 24px;
      margin: 0 auto;
    }
    .step { display: none; }
    .step.active { display: block; }
    h2 { 
      font-size: 1.5em; 
      margin-bottom: 0.75em; 
      text-align: center; 
      font-weight: 600;
      color: #1A202C;
    }
    
    /* Progress bar */
    .progress-bar { 
      height: 4px; 
      background-color: #EDF2F7; 
      border-radius: 2px; 
      margin-bottom: 1.25em; 
      overflow: hidden;
    }
    .progress-bar-inner { 
      height: 100%; 
      background-color: #E60303; 
      border-radius: 2px; 
      transition: width 0.3s ease;
    }
    
    /* Form elements */
    input, select, button, #card-element { 
      width: 100%; 
      padding: 0.85em; 
      font-size: 1rem !important; /* Consistent font size */
      font-family: 'Inter', sans-serif;
      border: 1px solid #E2E8F0; 
      border-radius: 6px;
      text-align: center;
      margin-bottom: 1em;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #CBD5E0;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }
    
    input::placeholder {
      color: #A0AEC0;
    }
    
    /* For Step 3 stake layout fix */
    .stake-container {
      margin-bottom: 1em;
    }
    #stake-custom {
      display: none;
      margin-bottom: 1em;
    }
    
    /* Connected input and button for other steps */
    .input-group { 
      display: flex; 
      flex-direction: column; 
      margin-bottom: 1em; 
    }
    .input-group input {
      border-radius: 6px 6px 0 0;
      border-bottom: none;
      margin-bottom: 0;
    }
    .input-group button {
      border-radius: 0 0 6px 6px;
    }
    
    /* Checkbox styling */
    .checkbox-field { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin-bottom: 1em; 
      padding: 0.5em;
    }
    .checkbox-field:hover {
      background-color: #F7FAFC;
      border-radius: 6px;
    }
    .checkbox-field input { 
      width: auto; 
      margin: 0; 
      transform: scale(1.2);
    }
    .checkbox-field label { 
      margin-left: 0.5em; 
      font-size: 0.9em; 
      text-align: left; 
      color: #4A5568;
    }
    
    /* Buttons container */
    .buttons { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 8px; 
      margin-bottom: 1em; 
    }
    
    /* Back button */
    .back-arrow { 
      font-size: 0.9rem;
      padding: 0.5em; 
      color: #A0AEC0; 
      border: none; 
      background: transparent; 
      cursor: pointer; 
      display: flex;
      align-items: center;
      justify-content: center;
      width: auto;
      opacity: 0.8;
      transition: all 0.2s;
      font-weight: 500;
    }
    .back-arrow:hover { 
      color: #718096;
      opacity: 1; 
    }
    
    /* Main button styling */
    button { 
      padding: 0.85em; 
      font-size: 1rem !important;
      background: #E60303; 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      width: 100%; 
      border-radius: 6px;
      font-weight: 500;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    button:hover:not([disabled]) {
      background: #d40000;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    button:active:not([disabled]) {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    
    /* Stripe element */
    #card-element { 
      padding: 14px; 
      border: 1px solid #E2E8F0; 
      border-radius: 6px; 
      margin-bottom: 1em; 
      background: white;
      transition: all 0.15s ease;
    }
    #card-element:hover {
      border-color: #CBD5E0;
    }
    
    #card-errors { 
      color: #E53E3E; 
      margin-top: 0.5em; 
      font-size: 0.9em; 
      text-align: center;
    }
    .error-message { 
      color: #E53E3E; 
      font-size: 0.9em; 
      margin-top: 0.5em; 
      margin-bottom: 1em; 
      display: none; 
      text-align: center; 
    }
    
    /* Security information section styling */
    .security-info {
      margin: 1.5em 0;
      padding: 1em;
      border-radius: 8px;
      background-color: #F7FAFC;
      border: 1px solid #EDF2F7;
      text-align: center;
    }

    .security-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.75em;
    }

    .security-badge svg {
      color: #38A169; /* Green color for the lock icon */
      margin-right: 0.5em;
    }

    .security-badge span {
      font-weight: 600;
      color: #2D3748;
      font-size: 0.95rem;
    }

    .security-info p {
      margin: 0.5em 0 0;
      color: #4A5568;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    
    /* Stripe branding */
    .powered-by-stripe {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0.5em;
      margin-bottom: 1em;
    }
    
    .powered-by-stripe span {
      color: #718096;
      font-size: 0.75rem;
      margin-right: 0.5em;
    }
    
    /* Save Card button styling */
    #payBtn {
      background-color: #E60303;
      font-weight: 600;
      padding: 0.9em;
      border-radius: 6px;
      margin: 0.75em 0;
      transition: all 0.2s;
    }

    #payBtn:hover:not([disabled]) {
      background-color: #d40000;
    }
    
    @media (max-width: 480px) { 
      #wizard { 
        border-radius: 0;
        box-shadow: none;
      } 
    }
  </style>
</head>
<body>
  <div id="wizard">

    <!-- Step 1: Goal -->
    <div class="step active" id="step-1">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 16.67%;"></div>
      </div>
      
      <h2>What is your goal?</h2>
      
      <div class="input-group">
        <input id="goal" placeholder="Enter your goal" />
        <button id="next-1">Let's go!</button>
      </div>
      
      <div id="goal-error" class="error-message">Please enter your goal</div>
    </div>

    <!-- Step 2: Deadline -->
    <div class="step" id="step-2">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 33.33%;"></div>
      </div>
      
      <h2>When</h2>
      
      <div class="input-group">
        <input id="deadline" type="date" />
        <button id="next-2">Set deadline</button>
      </div>
      
      <div id="deadline-error" class="error-message">Please select a date within the next 90 days</div>
      
      <div class="buttons">
        <button class="back-arrow" id="back-2">← Back</button>
      </div>
    </div>

    <!-- Step 3: Stake -->
    <div class="step" id="step-3">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 50%;"></div>
      </div>
      
      <h2>How much to pay if you fail</h2>
      
      <div class="stake-container">
        <select id="stake">
          <option value="25">$25</option>
          <option value="50">$50</option>
          <option value="100" selected>$100</option>
          <option value="500">$500</option>
          <option value="1500">$1,500</option>
          <option value="custom">Custom…</option>
        </select>
        
        <input id="stake-custom" placeholder="Enter custom amount" type="number" />
        
        <button id="next-3">Set Stake</button>
      </div>
      
      <div id="stake-error" class="error-message">Please enter a valid amount</div>
      
      <div class="buttons">
        <button class="back-arrow" id="back-3">← Back</button>
      </div>
    </div>

    <!-- Step 4: Referee -->
    <div class="step" id="step-4">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 66.67%;"></div>
      </div>
      
      <h2>Who checks if you complete it?</h2>
      
      <div class="input-group">
        <input id="refereeEmail" placeholder="Referee's email" type="email" />
        <button id="next-4">Set Referee</button>
      </div>
      
      <div id="referee-error" class="error-message">Please enter a valid email address</div>
      
      <div class="buttons">
        <button class="back-arrow" id="back-4">← Back</button>
      </div>
    </div>

    <!-- Step 5: Email & Terms -->
    <div class="step" id="step-5">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 83.33%;"></div>
      </div>
      
      <h2>How do we contact you?</h2>
      
      <div class="input-group">
        <input id="userEmail" placeholder="Your email" type="email" />
        <button id="next-5">Continue</button>
      </div>
      
      <div id="email-error" class="error-message">Please enter a valid email address</div>
      
      <div class="checkbox-field">
        <input id="terms" type="checkbox" />
        <label for="terms">I accept the Terms & Conditions</label>
      </div>
      <div id="terms-error" class="error-message">You must accept the Terms & Conditions</div>
      
      <div class="buttons">
        <button class="back-arrow" id="back-5">← Back</button>
      </div>
    </div>

    <!-- Step 6: Payment with enhanced trust elements -->
    <div class="step" id="step-6">
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: 100%;"></div>
      </div>
      
      <h2>You <strong>only</strong> pay if you fail your goal</h2>
      
      <input id="cardName" placeholder="Name on card" />
      <div id="cardname-error" class="error-message">Please enter the name on your card</div>
      
      <div id="card-element"></div>
      
      <input id="zip" placeholder="ZIP / Postal code" />
      <div id="zip-error" class="error-message">Please enter your ZIP/postal code</div>
      
      <div id="card-errors"></div>
      
      <!-- Security reassurance section -->
      <div class="security-info">
        <div class="security-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V6a6 6 0 1 1 12 0v6a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h1V6a5 5 0 0 0-5-5z"/>
          </svg>
          <span>Secure payment via Stripe</span>
        </div>
        <p>Your card will <strong>not be charged now</strong>. We only save your card details and will only charge if you don't complete your goal by the deadline.</p>
      </div>
      
      <button id="payBtn" disabled>Save Card</button>
      
      <!-- Stripe branding for additional trust -->
      <div class="powered-by-stripe">
        <span>Powered by</span>
        <svg width="60" height="25" viewBox="0 0 60 25" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M59.64 14.28C59.64 10.09 57.74 6.77 54.13 6.77C50.5 6.77 48.24 10.09 48.24 14.26C48.24 19.1 50.81 21.75 54.73 21.75C56.77 21.75 58.19 21.18 59.21 20.34V17.72C58.19 18.45 56.98 18.87 55.53 18.87C53.89 18.87 52.47 18.18 52.32 16.35H59.61C59.61 16.07 59.64 14.86 59.64 14.28ZM52.28 13.72C52.28 11.81 53.29 9.98 54.13 9.98C54.94 9.98 55.9 11.81 55.9 13.72H52.28ZM42.24 6.77C40.86 6.77 39.93 7.41 39.28 7.97L39.1 7.05H35.8V25H39.5V19.6L39.68 19.08C40.27 19.53 41.05 19.95 42.19 19.95C45.05 19.95 47.45 17.32 47.45 13.21C47.45 9.3 44.99 6.77 42.24 6.77ZM41.29 16.59C40.39 16.59 39.83 16.29 39.5 15.89V10.37C39.85 9.92 40.44 9.65 41.29 9.65C42.73 9.65 43.8 11.28 43.8 13.1C43.8 14.96 42.73 16.59 41.29 16.59ZM30.89 3.14L27.16 3.9L27.14 16.14C27.14 19.16 29.04 21.73 32.36 21.73C33.84 21.73 34.96 21.43 35.63 21.05V18.07C34.99 18.33 32.68 19 32.68 16.42V10.1H35.63V7.05H32.68L32.7 3.14H30.89ZM20.21 7.05L20.39 8.07C21.03 7.07 22.23 6.72 23.46 6.72C24.63 6.72 25.7 7.11 26.34 8.07C27.2 7.04 28.57 6.72 29.85 6.72C32.33 6.72 33.97 8.25 33.97 11.36V21.53H30.24V11.96C30.24 10.39 29.38 10.1 28.55 10.1C27.51 10.1 26.93 10.67 26.93 11.96V21.53H23.56V11.96C23.56 10.39 22.7 10.1 21.9 10.1C20.8 10.1 20.24 10.67 20.24 11.96V21.53H16.5V7.05H20.21ZM11.77 13.8V21.53H8.01V7.05H11.29L11.47 8.17C12.2 7.09 13.5 6.72 14.71 6.72C17.16 6.72 18.6 8.25 18.6 11.36V21.53H14.87V11.96C14.87 10.39 14.04 10.1 13.09 10.1C12.1 10.1 11.77 10.8 11.77 13.8Z" fill="#635BFF"/>
        </svg>
      </div>
      
      <div class="buttons">
        <button class="back-arrow" id="back-6">← Back</button>
      </div>
    </div>

  </div>

  <script>
    (async () => {
      const res = await fetch('/.netlify/functions/get-publishable-key');
      if (!res.ok) return console.error('Could not load publishable key');
      const { publishableKey } = await res.json();
      const stripe = Stripe(publishableKey);

      function showStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
      }

      // Validation functions
      function validateGoal() {
        const val = document.getElementById('goal').value.trim();
        const err = document.getElementById('goal-error');
        if (!val) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateDeadline() {
        const el = document.getElementById('deadline');
        const err = document.getElementById('deadline-error');
        if (!el.value) { err.style.display = 'block'; return false; }
        const date = new Date(el.value),
              now  = new Date(),
              max  = new Date(); max.setDate(now.getDate() + 90);
        if (date < now || date > max) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateStake() {
        const sel = document.getElementById('stake');
        const custom = document.getElementById('stake-custom').value;
        const err = document.getElementById('stake-error');
        if (sel.value === 'custom' && (!custom || custom <= 0)) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateEmail(id) {
        const val = document.getElementById(id).value.trim();
        const err = document.getElementById(id === 'userEmail' ? 'email-error': 'referee-error');
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!re.test(val)) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateTerms() {
        const chk = document.getElementById('terms').checked;
        const err = document.getElementById('terms-error');
        if (!chk) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateCardName() {
        const val = document.getElementById('cardName').value.trim();
        const err = document.getElementById('cardname-error');
        if (!val) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function validateZip() {
        const val = document.getElementById('zip').value.trim();
        const err = document.getElementById('zip-error');
        if (!val) { err.style.display = 'block'; return false; }
        err.style.display = 'none'; return true;
      }
      function enterKey(e, fn) { if (e.key === 'Enter') { e.preventDefault(); fn(); }}

      // Navigation
      document.getElementById('next-1').onclick = () => validateGoal() && showStep(2);
      document.getElementById('goal').addEventListener('keypress', e => enterKey(e, () => document.getElementById('next-1').click()));

      document.getElementById('next-2').onclick = () => validateDeadline() && showStep(3);
      document.getElementById('deadline').addEventListener('keypress', e => enterKey(e, () => document.getElementById('next-2').click()));
      document.getElementById('back-2').onclick = () => showStep(1);

      const stakeSel = document.getElementById('stake');
      stakeSel.onchange = () => document.getElementById('stake-custom').style.display = stakeSel.value === 'custom' ? 'block':'none';
      document.getElementById('next-3').onclick = () => validateStake() && showStep(4);
      document.getElementById('stake-custom').addEventListener('keypress', e => enterKey(e, () => document.getElementById('next-3').click()));
      document.getElementById('back-3').onclick = () => showStep(2);

      document.getElementById('next-4').onclick = () => validateEmail('refereeEmail') && showStep(5);
      document.getElementById('refereeEmail').addEventListener('keypress', e => enterKey(e, () => document.getElementById('next-4').click()));
      document.getElementById('back-4').onclick = () => showStep(3);

      document.getElementById('next-5').onclick = () => validateEmail('userEmail') && validateTerms() && showStep(6);
      document.getElementById('userEmail').addEventListener('keypress', e => enterKey(e, () => document.getElementById('next-5').click()));
      document.getElementById('back-5').onclick = () => showStep(4);

      document.getElementById('back-6').onclick = () => showStep(5);

      // Stripe card
      const elements = stripe.elements();
      const card = elements.create('card', { 
        hidePostalCode: true,
        style: {
          base: {
            fontFamily: "'Inter', sans-serif",
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
              color: '#9BACC8',
            },
          },
          invalid: {
            color: '#E53E3E',
          }
        }
      });
      card.mount('#card-element');
      const payBtn = document.getElementById('payBtn');
      card.on('change', e => { document.getElementById('card-errors').textContent = e.error?.message||''; payBtn.disabled = !e.complete; });

      const ORIGIN = location.origin.includes('netlify.app')?location.origin:'https://stately-sundae-b61659.netlify.app';
      async function createSetupIntent(payload) { return fetch(`${ORIGIN}/.netlify/functions/create-setup-intent`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }
      async function writeToAirtable(payload) { return fetch(`${ORIGIN}/.netlify/functions/submit-goal`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }

      payBtn.onclick = async () => {
        if (!validateCardName()||!validateZip()) return;
        const data={
          goal:document.getElementById('goal').value,
          deadline:document.getElementById('deadline').value,
          stake:stakeSel.value==='custom'?document.getElementById('stake-custom').value:stakeSel.value,
          supervisorEmail:document.getElementById('refereeEmail').value,
          refereeName:document.getElementById('refereeEmail').value.split('@')[0],
          email:document.getElementById('userEmail').value,
          name:document.getElementById('userEmail').value.split('@')[0],
          termsChecked:document.getElementById('terms').checked,
          cardName:document.getElementById('cardName').value,
          zip:document.getElementById('zip').value
        };
        payBtn.disabled=true;
        try {
          const siRes=await createSetupIntent(data);
          if (!siRes.ok) throw new Error(await siRes.text());
          const {clientSecret,customerId}=await siRes.json();
          const {error}=await stripe.confirmCardSetup(clientSecret,{payment_method:{card,billing_details:{name:data.cardName,address:{postal_code:data.zip}}}});
          if(error) throw error;
          const arRes=await writeToAirtable({...data,paymentStatus:'Card on file (test)',customerId});
          if(!arRes.ok) throw new Error(await arRes.text());
          
          window.location.href = 'https://motivationguaranteed.com/#success';
        }catch(err){console.error(err);payBtn.disabled=false;alert(`Error: ${err.message}`);}
      };
    })();
  </script>
</body>
</html>
