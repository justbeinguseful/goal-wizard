<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goal Wizard + Stripe & Airtable</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: transparent; }
    #wizard { max-width: 400px; margin: 20px auto; padding: 0 10px; }
    .step { display: none; }
    .step.active { display: block; }
    h2 { font-size: 1.5em; margin-bottom: 0.5em; text-align: center; }
    input, select { width: 100%; padding: 0.75em; font-size: 1em; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 4px; }
    .checkbox-field { display: flex; align-items: center; margin-bottom: 1em; }
    .checkbox-field input { margin: 0; }
    .checkbox-field label { margin-left: 0.5em; font-size: 0.9em; }
    .buttons { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 1.5em; }
    button { flex: 1; padding: 0.75em; font-size: 1em; background: #e53e3e; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    #card-element { padding: 12px; border: 1px solid #ccc; border-radius: 4px; }
    #card-errors { color: red; margin-top: 0.5em; font-size: 0.9em; }
    @media (max-width: 480px) { #wizard { margin: 10px; } button { font-size: 0.9em; } }
  </style>
</head>
<body>
  <div id="wizard">

    <!-- Step 1: Goal -->
    <div class="step active" id="step-1">
      <h2>Set Your Goal</h2>
      <input id="goal" placeholder="Your goal description" />
      <div class="buttons">
        <button id="next-1">Next →</button>
      </div>
    </div>

    <!-- Step 2: Deadline -->
    <div class="step" id="step-2">
      <h2>Set Deadline</h2>
      <input id="deadline" type="date" />
      <div class="buttons">
        <button id="back-2">← Back</button>
        <button id="next-2">Next →</button>
      </div>
    </div>

    <!-- Step 3: Stake -->
    <div class="step" id="step-3">
      <h2>Set Stake</h2>
      <select id="stake">
        <option value="25">$25</option>
        <option value="50">$50</option>
        <option value="100" selected>$100</option>
        <option value="500">$500</option>
        <option value="1500">$1,500</option>
        <option value="custom">Custom…</option>
      </select>
      <input id="stake-custom" placeholder="Enter custom amount" type="number" style="display:none;" />
      <div class="buttons">
        <button id="back-3">← Back</button>
        <button id="next-3">Next →</button>
      </div>
    </div>

    <!-- Step 4: Referee -->
    <div class="step" id="step-4">
      <h2>Your Referee</h2>
      <input id="refereeEmail" placeholder="Referee Email" type="email" />
      <div class="buttons">
        <button id="back-4">← Back</button>
        <button id="next-4">Next →</button>
      </div>
    </div>

    <!-- Step 5: Email & Terms -->
    <div class="step" id="step-5">
      <h2>Your Email & Terms</h2>
      <input id="userEmail" placeholder="Your Email" type="email" />
      <div class="checkbox-field">
        <input id="terms" type="checkbox" />
        <label for="terms">I accept the Terms & Conditions</label>
      </div>
      <div class="buttons">
        <button id="back-5">← Back</button>
        <button id="next-5">Next →</button>
      </div>
    </div>

    <!-- Step 6: Payment -->
    <div class="step" id="step-6">
      <h2>Save Your Card (no charge now)</h2>
      <input id="cardName" placeholder="Name on card" />
      <input id="zip" placeholder="ZIP / Postal code" />
      <div id="card-element"></div>
      <div id="card-errors"></div>
      <div class="buttons">
        <button id="back-6">← Back</button>
        <button id="payBtn" disabled>Save Card</button>
      </div>
    </div>

  </div>

  <script>
    (async () => {
      // ⚙️ Replace your hard-coded key with a fetch to the Function
      const res = await fetch('/.netlify/functions/get-publishable-key');
      if (!res.ok) {
        console.error('Could not load publishable key', await res.text());
        return;
      }
      const { publishableKey } = await res.json();

      // Initialize Stripe with the env-var
      const stripe = Stripe(publishableKey);

      // Helper to show/hide steps
      function showStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
      }

      // Navigation handlers
      document.getElementById('next-1').onclick = () => showStep(2);
      document.getElementById('back-2').onclick = () => showStep(1);
      document.getElementById('next-2').onclick = () => showStep(3);
      document.getElementById('back-3').onclick = () => showStep(2);
      document.getElementById('next-3').onclick = () => {
        const sel = document.getElementById('stake');
        if (sel.value === 'custom') document.getElementById('stake-custom').style.display = 'block';
        showStep(4);
      };
      document.getElementById('back-4').onclick = () => showStep(3);
      document.getElementById('next-4').onclick = () => showStep(5);
      document.getElementById('back-5').onclick = () => showStep(4);
      document.getElementById('next-5').onclick = () => showStep(6);

      // Mount the Stripe Card Element
      const elements = stripe.elements();
      const card = elements.create('card', { hidePostalCode: true });
      card.mount('#card-element');

      const payBtn = document.getElementById('payBtn');
      card.on('change', e => {
        document.getElementById('card-errors').textContent = e.error?.message || '';
        payBtn.disabled = !e.complete;
      });

      // Helper fns to call your Netlify Functions
      const NETLIFY_ORIGIN = location.origin.includes('netlify.app')
        ? location.origin
        : 'https://stately-sundae-b61659.netlify.app';

      async function createSetupIntent(payload) {
        return fetch(`${NETLIFY_ORIGIN}/.netlify/functions/create-setup-intent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }

      async function writeToAirtable(payload) {
        return fetch(`${NETLIFY_ORIGIN}/.netlify/functions/submit-goal`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }

      // Final submit: save card & write Airtable
      payBtn.onclick = async () => {
        const goal             = document.getElementById('goal').value;
        const deadline         = document.getElementById('deadline').value;
        let stake              = document.getElementById('stake').value;
        if (stake === 'custom') stake = document.getElementById('stake-custom').value;
        const supervisorEmail  = document.getElementById('refereeEmail').value;
        const refereeName      = supervisorEmail.split('@')[0];
        const email            = document.getElementById('userEmail').value;
        const name             = email.split('@')[0];
        const termsChecked     = document.getElementById('terms').checked;
        const cardName         = document.getElementById('cardName').value;
        const zip              = document.getElementById('zip').value;

        try {
          // 1️⃣ Create SetupIntent
          const siRes = await createSetupIntent({
            goal,
            deadline,
            stake,
            supervisorEmail,
            refereeName,
            email,
            name,
            termsChecked,
            cardName,
            zip
          });
          if (!siRes.ok) throw new Error(`SetupIntent failed: ${await siRes.text()}`);
          const { clientSecret, customerId } = await siRes.json(); // Get customerId from response

          // 2️⃣ Confirm Card Setup
          const { error } = await stripe.confirmCardSetup(clientSecret, {
            payment_method: {
              card,
              billing_details: { name: cardName, address: { postal_code: zip } }
            }
          });
          if (error) throw error;

          // 3️⃣ Write to Airtable
          const arRes = await writeToAirtable({
            name,
            email,
            goal,
            deadline,
            stake,
            refereeName,
            supervisor: supervisorEmail,
            termsChecked,
            paymentStatus: 'Card on file (test)',
            customerId  // Add customerId to Airtable record
          });
          if (!arRes.ok) throw new Error(`Airtable save failed: ${await arRes.text()}`);

          alert('✅ Goal saved!');
          showStep(1);
        } catch (err) {
          console.error(err);
          alert(`Error: ${err.message}`);
        }
      };

    })();
  </script>
</body>
</html>
